---

#- name: Set tempalte list
#  ansible.builtin.set_fact:
#    configured_template_list: "{{ team_roles | selectattr('name', 'equalto', team_role.name) | selectattr('resource_type', 'equalto', team_role.resource_type) | selectattr('perm', 'equalto', team_role.perm) | map(attribute='resource_name')}}"

#- name: Extract {{ team_role.resource_type }} list with {{ team_role.perm }} for {{ team_role.name }}
#  ansible.builtin.debug:
#    msg: "{{ configured_template_list }}"

- name: Extract full template list
  ansible.builtin.set_fact:
    configured_template_list: "{{ team_roles | selectattr('name', 'equalto', team_role.name) | selectattr('resource_type', 'equalto', team_role.resource_type) | selectattr('perm', 'equalto', team_role.perm) | map(attribute='resource_name')}}"
    job_template_name: "{{ job_template_ids | map(attribute='name') }}"
    workflow_job_template_name: "{{ workflow_job_template_ids | map(attribute='name') }}"

- name: Missing workflow job template
  when: team_role.resource_type == 'workflow_job_template'
  block:
    - name: Find the missing template
      ansible.builtin.set_fact:
        missing_wf_templates: "{{ workflow_job_template_name | difference(configured_template_list) }}"

    - name: Ensure all workflow templates configured for {{ team_role.name }}
      ansible.builtin.fail:
        msg: "{{ missing_wf_templates }}"
      when: missing_wf_templates | length > 0
  rescue:
    - name: The job template not in conf list
      ansible.builtin.debug:
        msg: "Missing workflow tempalte for {{ team_role.name }} with {{ team_role.perm }} :\n {{ missing_wf_templates }}"
  
- name: Missing job template 
  when: team_role.resource_type == 'job_template'
  block:
    - name: Debug
      ansible.builtin.set_fact:
        missing_templates: "{{ job_template_name | difference(configured_template_list) }}"

    - name: Ensure all templates configured for {{ team_role.name }}
      ansible.builtin.fail:
        msg: "{{ missing_templates }}"
      when: missing_templates | length > 0
  rescue:
    - name: The job template not in conf list
      ansible.builtin.debug:
        msg: "Missing tempalte for {{ team_role.name }} with {{ team_role.perm }} :\n {{ missing_templates }}"
  
#- name: The job template not in conf list
#  ansible.builtin.debug:
#    msg: "{{ job_template_name | difference(configured_template_list) }}"
#  when: team_role.resource_type == 'job_template'
